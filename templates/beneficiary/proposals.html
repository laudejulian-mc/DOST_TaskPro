{% extends "beneficiary/base.html" %}
{% load static %}

{% block title %}Proposals{% endblock %}
{% block nav-proposals %}active-nav{% endblock %}
{% block page-title %}Proposals{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<div class="container mt-2" x-data="{ openAdd: false, openEdit: false, editProposal: {} }">

    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-3 rounded-lg text-white 
                        {% if message.tags == 'success' %} bg-green-500 
                        {% elif message.tags == 'error' %} bg-red-500 
                        {% else %} bg-blue-500 {% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Add Proposal Button -->
    <div class="flex justify-end mb-4">
        <button @click="openAdd = true"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg shadow">
            + Add Proposal
        </button>
    </div>

    <!-- Proposals Table -->
    <div class="overflow-x-auto bg-white shadow-md rounded-lg p-4">
        <table id="proposalsTable" class="min-w-full text-sm text-left text-gray-600">
            <thead class="bg-gray-100 text-gray-700">
                <tr>
                    <th class="px-4 py-2">#</th>
                    <th class="px-4 py-2">Title</th>
                    <th class="px-4 py-2">Proponent</th>
                    <th class="px-4 py-2">Beneficiary</th>
                    <th class="px-4 py-2">Proposed Amount</th>
                    <th class="px-4 py-2">Approved Amount</th>
                    <th class="px-4 py-2">Budget</th>
                    <th class="px-4 py-2">File</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2 text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for proposal in proposals %}
                <tr>
                    <td class="px-4 py-2">{{ forloop.counter }}</td>
                    <td class="px-4 py-2">{{ proposal.title }}</td>
                    <td class="px-4 py-2">{{ proposal.processed_by.get_full_name }}</td>
                    <td class="px-4 py-2">{{ proposal.beneficiary.get_full_name }}</td>
                    <td class="px-4 py-2">{{ proposal.proposed_amount }}</td>
                    <td class="px-4 py-2">{{ proposal.approved_amount }}</td>
                    <td class="px-4 py-2">{{ proposal.budget.fund_source }} {{ proposal.budget.fiscal_year }}</td>
                    <td class="px-4 py-2">
                         {% if proposal.document %}
                            <a href="{{ proposal.document.url }}" target="_blank"
                            class="px-3 py-1 text-white bg-red-500 rounded hover:bg-red-600">
                            PDF 
                            </a>
                            {% endif %}
                    </td>
                    <td class="px-4 py-2 text-center">
                        {% if proposal.status == 'pending' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800 font-medium">Pending</span>
                        {% elif proposal.status == 'for_review' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-blue-100 text-blue-800 font-medium">For Review</span>
                        {% elif proposal.status == 'approved' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-green-100 text-green-800 font-medium">Approved</span>
                        {% elif proposal.status == 'rejected' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-red-100 text-red-800 font-medium">Rejected</span>
                        {% elif proposal.status == 'needs_revision' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-orange-100 text-orange-800 font-medium">Needs Revision</span>
                        {% endif %}
                    </td>

                    <td class="px-4 py-2 text-center">
                        <div class="flex justify-center gap-2">                           
                            {% if proposal.status == 'pending' %}
                            N/A
                                <!-- <button type="button"
                                    class="px-3 py-1 text-white bg-yellow-500 rounded hover:bg-yellow-600 editBtn"
                                    data-id="{{ proposal.id }}"
                                    data-title="{{ proposal.title }}"
                                    data-description="{{ proposal.description }}"
                                    data-proposed_amount="{{ proposal.proposed_amount }}"
                                    data-approved_amount="{{ proposal.approved_amount }}"
                                    {% if proposal.budget %}
                                        data-budget="{{ proposal.budget.id }}"
                                    {% else %}
                                        data-budget=""
                                    {% endif %}
                                    data-document-url="{% if proposal.document %}{{ proposal.document.url }}{% endif %}"
                                    {% if proposal.processed_by %}
                                        data-processed_by="{{ proposal.processed_by.id }}"
                                    {% else %}
                                        data-processed_by=""
                                    {% endif %}
                                    {% if proposal.beneficiary %}
                                        data-beneficiary="{{ proposal.beneficiary.id }}"
                                    {% else %}
                                        data-beneficiary=""
                                    {% endif %}
                            >
                                Edit
                            </button>                         -->
                                {% endif %}
                               {% if proposal.review_remarks %}
                                <button type="button" 
                                        class="mt-2 px-4 py-2 bg-[#0072CE] text-white rounded shadow hover:bg-blue-900 flex items-center gap-2"
                                        data-remarks="{{ proposal.review_remarks|escape }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                                    </svg>
                                    View Remarks
                                </button>
                                <!-- Remarks Modal -->
                                <div id="remarksModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                                    <div class="bg-white rounded-xl w-11/12 md:w-1/2 shadow-xl overflow-hidden">
                                        <!-- Header -->
                                        <div class="bg-[#0072CE] text-white px-6 py-4 flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                                            </svg>
                                            <h2 class="text-xl font-bold">Remarks</h2>
                                        </div>

                                        <!-- Content -->
                                        <div class="p-6">
                                            <p id="modalRemarksContent" class="text-gray-800 text-justify text-sm"></p>
                                        </div>

                                        <!-- Close Button -->
                                        <div class="flex justify-end p-4">
                                            <button id="closeRemarksModal" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Close</button>
                                        </div>
                                    </div>
                                </div>
                                <script>
                                // Open modal when button is clicked
                                document.querySelectorAll('button[data-remarks]').forEach(btn => {
                                    btn.addEventListener('click', () => {
                                        const remarks = btn.dataset.remarks;
                                        document.getElementById('modalRemarksContent').innerText = remarks;
                                        document.getElementById('remarksModal').classList.remove('hidden');
                                    });
                                });

                                // Close modal
                                document.getElementById('closeRemarksModal').addEventListener('click', () => {
                                    document.getElementById('remarksModal').classList.add('hidden');
                                });
                                </script>
                                {% endif %}
                       
                                <!-- Approved Badge (Clickable) -->
                                {% if proposal.status == 'approved' %}
                                   <a href="{% url 'beneficiary_projects_url' %}" 
                                    class="inline-flex items-center gap-2 bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full shadow-md hover:bg-green-200 transition duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                        </svg>
                                        Project
                                    </a>
                                {% endif %}                                
                                                      
                        </div>
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Add Proposal Modal -->
    <div x-show="openAdd" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto" x-cloak>
        <div @click.away="openAdd = false" class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg mt-10 mb-10 overflow-y-auto max-h-[90vh]">
            <h2 class="text-lg font-semibold mb-4">Add Proposal</h2>
            <form method="POST" action="{% url 'beneficiary_proposals_add_url' %}" enctype="multipart/form-data" class="space-y-3">
                {% csrf_token %}
                 <div>
                    <label class="block text-sm font-medium">Proponent</label>
                    <select name="processed_by" class="form-control w-full border rounded-lg px-3 py-2" required>
                        <option value="">-- Select Proponent --</option>
                        {% for user in proponents %}
                            <option value="{{ user.id }}">{{ user.get_full_name }} - {{ user.address }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Beneficiary -->
                <div>
                    <label class="block text-sm font-medium">Beneficiary</label>
                    <select name="beneficiary" class="form-control w-full border rounded-lg px-3 py-2">
                        <option value="">-- Select Beneficiary --</option>
                        {% for user in beneficiaries %}
                            <option value="{{ user.id }}">{{ user.get_full_name }} - {{ user.address }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium">Title</label>
                    <input type="text" name="title" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Description</label>
                    <textarea name="description" class="w-full border rounded-lg px-3 py-2 h-48"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium">Proposed Amount</label>
                        <input type="number" step="0.01" name="proposed_amount" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Budget</label>
                        <select name="budget" class="w-full border rounded-lg px-3 py-2">
                            <option value="">Select Budget</option>
                            {% for budget in budgets %}
                            <option value="{{ budget.id }}">{{ budget.fund_source }} ({{ budget.fiscal_year }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium">Document</label>
                    <input type="file" name="document" accept="application/pdf" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div class="flex justify-end gap-2 pt-3">
                    <button type="button" @click="openAdd = false" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const pdfInputs = document.querySelectorAll("input[type='file'][name='document'], input[type='file'][name='budget_document']");

    pdfInputs.forEach(input => {
        input.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                if (file.type !== "application/pdf") {
                    alert("Invalid file type. Please upload a PDF file only.");
                    this.value = ""; // Reset invalid file
                }
            }
        });
    });
});
</script>

    <!-- Edit Proposal Modal -->
<div x-show="openEdit" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto" x-cloak>
    <div @click.away="openEdit = false" class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg mt-10 mb-10 overflow-y-auto max-h-[90vh]">
        <h2 class="text-lg font-semibold mb-4">Edit Proposal</h2>
        <form method="POST" :action="`/base/proposals/update/${editProposal.id}/`" enctype="multipart/form-data" class="space-y-3">
            {% csrf_token %}

            <!-- Proponent -->
            <div>
                <label class="block text-sm font-medium">Proponent</label>
                <select name="processed_by" class="form-control w-full border rounded-lg px-3 py-2" x-model="editProposal.processed_by" required>
                    <option value="">-- Select Proponent --</option>
                    {% for user in proponents %}
                        <option value="{{ user.id }}" :selected="editProposal.processed_by == '{{ user.id }}'">
                            {{ user.get_full_name }} - {{ user.address }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Beneficiary -->
            <div>
                <label class="block text-sm font-medium">Beneficiary</label>
                <select name="beneficiary" class="form-control w-full border rounded-lg px-3 py-2" x-model="editProposal.beneficiary">
                    <option value="">-- Select Beneficiary --</option>
                    {% for user in beneficiaries %}
                        <option value="{{ user.id }}" :selected="editProposal.beneficiary == '{{ user.id }}'">
                            {{ user.get_full_name }} - {{ user.address }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Title -->
            <div>
                <label class="block text-sm font-medium">Title</label>
                <input type="text" name="title" x-model="editProposal.title" class="w-full border rounded-lg px-3 py-2" required>
            </div>

            <!-- Description -->
            <div>
                <label class="block text-sm font-medium">Description</label>
                <textarea name="description" x-model="editProposal.description" 
                        class="w-full border rounded-lg px-3 py-2 h-48"></textarea>
            </div>


            <!-- Amounts & Budget -->
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm font-medium">Proposed Amount</label>
                    <input type="number" step="0.01" name="proposed_amount" x-model="editProposal.proposed_amount" class="w-full border rounded-lg px-3 py-2" disabled>
                </div>
             
                <div>
                    <label class="block text-sm font-medium">Budget</label>
                    <select name="budget" class="w-full border rounded-lg px-3 py-2" x-model="editProposal.budget" disabled>
                        <option value="">Select Budget</option>
                        {% for budget in budgets %}
                            <option :value="{{ budget.id }}">{{ budget.fund_source }} ({{ budget.fiscal_year }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Document -->
            <div>
                <label class="block text-sm font-medium">Document</label>
                <input type="file" name="document" accept="application/pdf" class="w-full border rounded-lg px-3 py-2">
                <template x-if="editProposal.document_url">
                    <a :href="editProposal.document_url" target="_blank"
                       class="mt-5 inline-flex items-center justify-center w-full px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg shadow transition duration-200 mt-1">
                        View Current Document
                    </a>
                </template>
            </div>

            <!-- Buttons -->
            <div class="flex justify-end gap-2 pt-3">
                <button type="button" @click="openEdit = false" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Update</button>
            </div>
        </form>
    </div>
</div>


</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Target both proposals and budget file inputs
    const pdfInputs = document.querySelectorAll(
        "input[type='file'][name='document'], input[type='file'][name='budget_document']"
    );

    pdfInputs.forEach(input => {
        input.addEventListener("change", function () {
            const file = this.files[0];
            if (file && file.type !== "application/pdf") {
                alert("Invalid file type. Please upload a PDF only.");
                this.value = ""; // Reset invalid file
            }
        });
    });
});
</script>

<script>
    $(document).ready(function () {
        $('#proposalsTable').DataTable();

        document.querySelectorAll('.editBtn').forEach(button => {
                button.addEventListener('click', function () {
                    const root = document.querySelector('[x-data]');
                    const alpine = Alpine.$data(root);

                    alpine.editProposal = {
                        id: this.dataset.id,
                        title: this.dataset.title,
                        description: this.dataset.description,
                        proposed_amount: this.dataset.proposed_amount,
                        approved_amount: this.dataset.approved_amount,
                        budget: this.dataset.budget,
                        document_url: this.dataset.documentUrl,
                        processed_by: this.dataset.processed_by // <-- added
                    };

                    alpine.openEdit = true;
                });
            });
    });
</script>

{% endblock %}
