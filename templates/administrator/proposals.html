{% extends "administrator/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Proposals{% endblock %}
{% block nav-proposals %}active-nav{% endblock %}
{% block page-title %}Proposals{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<!-- Leaflet CSS/JS for location map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container mt-2" x-data="{ 
    selectedIds: [], 
    openMassDelete: false,
    selectAll: false,
    toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.proposal-checkbox');
        if (this.selectAll) {
            this.selectedIds = Array.from(checkboxes).map(cb => cb.value);
        } else {
            this.selectedIds = [];
        }
    },
    updateSelectAll() {
        const checkboxes = document.querySelectorAll('.proposal-checkbox');
        this.selectAll = this.selectedIds.length === checkboxes.length && checkboxes.length > 0;
    }
}">

    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-3 rounded-lg text-white 
                        {% if message.tags == 'success' %} bg-green-500 
                        {% elif message.tags == 'error' %} bg-red-500 
                        {% else %} bg-blue-500 {% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Action Buttons -->
    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-2">
            <!-- Mass Delete Button (shown when items selected) -->
            <template x-if="selectedIds.length > 0">
                <button @click="openMassDelete = true"
                    class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded-lg shadow flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete Selected (<span x-text="selectedIds.length"></span>)
                </button>
            </template>
        </div>
        <button onclick="document.getElementById('addProposalModal').style.display='block'; setTimeout(initMap, 200)"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg shadow">
            + Add Proposal
        </button>
    </div>

    <!-- Proposals Table -->
    <div class="overflow-x-auto bg-white shadow-md rounded-lg p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                Project Proposals
                <span class="tooltip-container ml-2">
                    <span class="tooltip-icon">?</span>
                    <span class="tooltip-text">Review and manage project proposals submitted by proponents. Approve proposals to convert them into funded projects, or decline them with feedback. Use the interactive map to visualize project locations.</span>
                </span>
            </h3>
        </div>
        <table id="proposalsTable" class="min-w-full text-sm text-left text-gray-600">
            <thead class="bg-gray-100 text-gray-700">
                <tr>
                    <th class="px-2 py-2 w-10">
                        <input type="checkbox" x-model="selectAll" @change="toggleSelectAll()" 
                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    </th>
                    <th class="px-4 py-2">#</th>
                    <th class="px-4 py-2">Title</th>
                    <th class="px-4 py-2">Proponent</th>
                    <th class="px-4 py-2">Beneficiary</th>
                    <th class="px-4 py-2">Location</th>
                    <th class="px-4 py-2">Proposed Amount</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2">Documents</th>
                    <th class="px-4 py-2 text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for proposal in proposals %}
                <tr>
                    <td class="px-2 py-2">
                        <input type="checkbox" class="proposal-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                            value="{{ proposal.id }}"
                            x-model="selectedIds"
                            @change="updateSelectAll()">
                    </td>
                    <td class="px-4 py-2">{{ forloop.counter }}</td>
                    <td class="px-4 py-2">{{ proposal.title }}</td>
                    <td class="px-4 py-2">{{ proposal.proponent.full_name|default:"-" }}</td>
                    <td class="px-4 py-2">{{ proposal.beneficiary.full_name|default:"-" }}</td>
                    <td class="px-4 py-2">
                        {% if proposal.municipality or proposal.province %}
                            {{ proposal.municipality }}{% if proposal.municipality and proposal.province %}, {% endif %}{{ proposal.province }}
                        {% else %}
                            {{ proposal.location|default:"-" }}
                        {% endif %}
                    </td>
                    <td class="px-4 py-2">‚Ç±{{ proposal.proposed_amount|floatformat:0|intcomma|default:"0" }}</td>
                    <td class="px-4 py-2 text-center">
                        {% if proposal.status == 'pending' %}
                            <span class="px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-800 font-medium">Pending</span>
                        {% elif proposal.status == 'for_review' %}
                            <span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800 font-medium">For Review</span>
                        {% elif proposal.status == 'approved' %}
                            <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800 font-medium">Approved</span>
                        {% elif proposal.status == 'rejected' %}
                            <span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-800 font-medium">Rejected</span>
                        {% elif proposal.status == 'needs_revision' %}
                            <span class="px-2 py-1 rounded-full text-xs bg-orange-100 text-orange-800 font-medium">Needs Revision</span>
                        {% endif %}
                    </td>
                    
                    <!-- Documents Column -->
                    <td x-data="{ openDocs: false }" class="px-4 py-2 text-center">
                        {% if proposal.documents.count > 0 %}
                            <button @click="openDocs = true" class="px-2 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 text-xs">
                                üìÑ {{ proposal.documents.count }} file{{ proposal.documents.count|pluralize }}
                            </button>
                            <!-- Documents Modal -->
                            <div x-show="openDocs" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" x-cloak>
                                <div @click.away="openDocs = false" class="bg-white w-full max-w-lg p-6 rounded-lg shadow-lg text-left">
                                    <h3 class="text-lg font-semibold mb-4">Documents for {{ proposal.title|truncatewords:5 }}</h3>
                                    <ul class="space-y-2 max-h-64 overflow-y-auto">
                                        {% for doc in proposal.documents.all %}
                                        <li class="flex items-center justify-between bg-gray-50 p-2 rounded group">
                                            <span class="truncate flex-1 text-gray-700">üìé {{ doc.filename }}</span>
                                            <div class="flex items-center gap-1">
                                                <button onclick="previewDocument('{{ doc.file.url }}', '{{ doc.filename }}')" 
                                                        class="p-1 text-blue-600 hover:bg-blue-100 rounded" title="Preview">
                                                    <span class="material-icons text-sm">visibility</span>
                                                </button>
                                                <a href="{{ doc.file.url }}" download 
                                                   class="p-1 text-green-600 hover:bg-green-100 rounded" title="Download">
                                                    <span class="material-icons text-sm">download</span>
                                                </a>
                                                <a href="{% url 'delete_proposal_document' doc.id %}" 
                                                   onclick="return confirm('Delete this document?')"
                                                   class="p-1 text-red-500 hover:bg-red-100 rounded" title="Delete">
                                                    <span class="material-icons text-sm">delete</span>
                                                </a>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <div class="mt-4 text-right">
                                        <button @click="openDocs = false" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <span class="text-gray-400 text-xs">No files</span>
                        {% endif %}
                    </td>

                    <td class="px-4 py-2">
                        <!-- Clean Action Buttons with Dropdown -->
                        <div class="flex items-center justify-center gap-1">
                            <!-- Primary Actions (Always visible) -->
                            <div class="inline-flex rounded-md shadow-sm" role="group">
                                <!-- Edit Button -->
                                <button type="button"
                                    class="px-2 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-l-md hover:bg-gray-100 editBtn"
                                    onclick="window.openEditModal(this)"
                                    data-id="{{ proposal.id }}"
                                    data-title="{{ proposal.title }}"
                                    data-description="{{ proposal.description }}"
                                    data-proposed_amount="{{ proposal.proposed_amount }}"
                                    data-approved_amount="{{ proposal.approved_amount }}"
                                    data-budget="{{ proposal.budget.id|default:'' }}"
                                    data-status="{{ proposal.status }}"
                                    data-proponent="{{ proposal.proponent.id|default:'' }}"
                                    data-beneficiary="{{ proposal.beneficiary.id|default:'' }}"
                                    data-location="{{ proposal.location|default:'' }}"
                                    data-municipality="{{ proposal.municipality|default:'' }}"
                                    data-province="{{ proposal.province|default:'' }}"
                                    data-document-url="{% if proposal.document %}{{ proposal.document.url }}{% endif %}"
                                    title="Edit">
                                    <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>

                                {% if proposal.status == 'pending' or proposal.status == 'for_review' or proposal.status == 'needs_revision' %}
                                <!-- Approve Button -->
                                <button type="button"
                                    class="px-2 py-1.5 text-xs font-medium text-green-700 bg-white border-t border-b border-gray-300 hover:bg-green-50 approveBtn"
                                    data-id="{{ proposal.id }}"
                                    data-title="{{ proposal.title }}"
                                    data-description="{{ proposal.description }}"
                                    data-proposed_amount="{{ proposal.proposed_amount }}"
                                    {% if proposal.budget %}data-budget="{{ proposal.budget.fund_source }}"{% else %}data-budget=""{% endif %}
                                    data-document-url="{% if proposal.document %}{{ proposal.document.url }}{% endif %}"
                                    title="Approve">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </button>

                                <!-- Decline Button -->
                                <button type="button"
                                    class="px-2 py-1.5 text-xs font-medium text-red-700 bg-white border-t border-b border-gray-300 hover:bg-red-50 declineBtn"
                                    data-id="{{ proposal.id }}"
                                    data-title="{{ proposal.title }}"
                                    title="Decline">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                                {% endif %}

                                <!-- E-Sign Button -->
                                <button type="button"
                                    onclick="openSignatureModal('proposal', '{{ proposal.id }}')"
                                    class="px-2 py-1.5 text-xs font-medium text-purple-700 bg-white border-t border-b border-gray-300 hover:bg-purple-50"
                                    title="Add E-Signature">
                                    <span class="material-icons text-sm">draw</span>
                                </button>

                                {% if proposal.review_remarks %}
                                <!-- Remarks Button -->
                                <button type="button" 
                                    class="px-2 py-1.5 text-xs font-medium text-blue-700 bg-white border-t border-b border-gray-300 hover:bg-blue-50 remarksBtn"
                                    data-remarks="{{ proposal.review_remarks|escape }}"
                                    title="View Remarks">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                    </svg>
                                </button>
                                {% endif %}

                                <!-- Delete Button -->
                                <button type="button"
                                    class="px-2 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-r-md hover:bg-gray-100 relative"
                                    onclick="window.openDeleteModal('{{ proposal.id }}', '{{ proposal.title|escapejs }}')"
                                    title="Delete">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    <span class="tooltip-container absolute -top-1 -right-1">
                                        <span class="tooltip-icon text-xs">?</span>
                                        <span class="tooltip-text">Permanently delete this proposal</span>
                                    </span>
                                </button>
                            </div>

                            {% if proposal.status == 'approved' %}
                            {% if proposal.project %}
                            <!-- View Project Button -->
                            <button type="button"
                                class="ml-1 px-2 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-200 rounded-md hover:bg-blue-100 inline-flex items-center gap-1"
                                @click="openProjectModal({
                                    id: {{ proposal.project.id }},
                                    project_title: '{{ proposal.project.project_title|escapejs }}',
                                    status: '{{ proposal.project.status }}',
                                    program: '{{ proposal.project.program|escapejs }}',
                                    type_of_project: '{{ proposal.project.type_of_project|escapejs }}',
                                    fund_source: '{{ proposal.project.fund_source|escapejs }}',
                                    project_leader: {% if proposal.project.project_leader %}{get_full_name: '{{ proposal.project.project_leader.get_full_name|escapejs }}'}{% else %}null{% endif %},
                                    mun: '{{ proposal.project.mun|escapejs }}',
                                    province: '{{ proposal.project.province|escapejs }}',
                                    district: '{{ proposal.project.district|escapejs }}',
                                    male: {{ proposal.project.male|default:0 }},
                                    female: {{ proposal.project.female|default:0 }},
                                    senior_citizen: {{ proposal.project.senior_citizen|default:0 }},
                                    pwd: {{ proposal.project.pwd|default:0 }},
                                    no_of_beneficiaries: {{ proposal.project.no_of_beneficiaries|default:0 }},
                                    funds: '{{ proposal.project.funds|default:"0" }}',
                                    total_funds_released: '{{ proposal.project.total_funds_released|default:"0" }}',
                                    amount_liquidated: '{{ proposal.project.amount_liquidated|default:"0" }}',
                                    project_start: {% if proposal.project.project_start %}'{{ proposal.project.project_start|date:"Y-m-d" }}'{% else %}null{% endif %},
                                    project_end: {% if proposal.project.project_end %}'{{ proposal.project.project_end|date:"Y-m-d" }}'{% else %}null{% endif %},
                                    contact_details: '{{ proposal.project.contact_details|escapejs|default:"" }}',
                                    proponent_details: '{{ proposal.project.proponent_details|escapejs|default:"" }}'
                                })"
                                title="View Project">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                View Project
                            </button>
                            {% else %}
                            <!-- Add Project Button (pre-fills project form with proposal data) -->
                            <a href="{% url 'administrator_projects_url' %}?from_proposal={{ proposal.id }}&title={{ proposal.title|urlencode }}&description={{ proposal.description|urlencode }}&beneficiary={{ proposal.beneficiary.full_name|urlencode }}&proponent={{ proposal.proponent.full_name|urlencode }}&municipality={{ proposal.municipality|urlencode }}&province={{ proposal.province|urlencode }}&location={{ proposal.location|urlencode }}&amount={{ proposal.approved_amount|default:proposal.proposed_amount }}" 
                                class="ml-1 px-2 py-1.5 text-xs font-medium text-green-700 bg-green-50 border border-green-200 rounded-md hover:bg-green-100 inline-flex items-center gap-1"
                                title="Add Project from this Proposal">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Add Project
                            </a>
                            {% endif %}
                            {% endif %}
                        </div>
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Decline Modal (Single instance outside the loop) -->
    <div id="declineModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl w-11/12 md:w-1/2 shadow-xl overflow-hidden">
            <div class="bg-red-600 text-white px-6 py-4">
                <h2 class="text-2xl font-bold">Decline Proposal</h2>
            </div>
            <form id="declineForm" method="POST" action="{% url 'administrator_proposals_decline_url' %}" class="p-6 space-y-4">
                {% csrf_token %}
                <input type="hidden" name="proposal_id" id="declineProposalId">
                <div>
                    <label class="font-semibold block mb-1">Title</label>
                    <p id="declineModalTitle" class="text-left text-justify font-bold"></p>
                </div>
                <div>
                    <label class="font-semibold block mb-1">Reason for Decline</label>
                    <textarea name="decline_reason" rows="5" required
                        class="w-full border border-gray-300 rounded p-2 resize-y min-h-[150px] max-h-[300px]"
                        placeholder="Enter reason for declining this proposal"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="closeDeclineModal" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Decline</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Approve Modal (Single instance outside the loop) -->
    <div id="approveModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto">
        <div class="bg-white rounded-xl w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="bg-[#0072CE] text-white px-6 py-4 flex-shrink-0">
                <h2 class="text-3xl font-extrabold">Approve Proposal</h2>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto">
                <form id="approveForm" method="POST" action="{% url 'administrator_proposals_approve_url' 0 %}">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="approved">
                    <input type="hidden" name="proposal_id" id="modalProposalId">
                    <div>
                        <label class="font-semibold block mb-1">Title</label>
                        <p id="modalTitle" class="text-lg font-bold text-left text-justify"></p>
                    </div>
                    <div>
                        <label class="font-semibold block mb-1">Description</label>
                        <p id="modalDescription" class="italic font-serif text-left text-justify"></p>
                    </div><br>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start text-center">
                        <div>
                            <label class="font-semibold block mb-1">Proposed Amount</label>
                            <p id="modalProposedAmount" class="text-center"></p>
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">Budget</label>
                            <p id="modalBudget" class="text-center"></p>
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">Document</label>
                            <a id="modalDocument" href="#" target="_blank"
                                class="flex items-center justify-center gap-3 px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 w-full">
                                View Document
                            </a>
                        </div>
                    </div>
                    <hr class="my-4 border-gray-300">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="project_start_date" class="font-semibold mb-2">Start Date</label>
                            <input type="date" id="project_start_date" name="project_start_date"
                                class="w-full border border-gray-300 rounded p-2 text-left">
                        </div>
                        <div>
                            <label for="project_end_date" class="font-semibold mb-2">End Date</label>
                            <input type="date" id="project_end_date" name="project_end_date"
                                class="w-full border border-gray-300 rounded p-2 text-left">
                        </div>
                    </div>
                    <div class="flex flex-col items-start mt-4">
                        <label for="approved_amount" class="font-semibold mb-2">Approved Amount</label>
                        <input type="number" id="approved_amount" step="0.01" name="approved_amount"
                            class="w-full border border-gray-300 rounded p-2 text-left placeholder-gray-400"
                            placeholder="Enter the amount" required>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" id="closeModal"
                            class="px-5 py-2 bg-gray-400 text-white rounded hover:bg-gray-500 transition">Cancel</button>
                        <button type="submit"
                            class="px-5 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                            </svg>
                            Approve
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Remarks Modal (Single instance outside the loop) -->
    <div id="remarksModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl w-11/12 md:w-1/2 shadow-xl overflow-hidden">
            <div class="bg-[#0072CE] text-white px-6 py-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                </svg>
                <h2 class="text-xl font-bold">Remarks</h2>
            </div>
            <div class="p-6">
                <p id="modalRemarksContent" class="text-gray-800 text-justify text-sm"></p>
            </div>
            <div class="flex justify-end p-4">
                <button id="closeRemarksModal" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Proposal Modal -->
    <div id="addProposalModal" style="display: none;" onclick="if(event.target === this) this.style.display='none'" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto z-50" style="padding: 2rem 0;">
        <div class="flex items-center justify-center min-h-full">
            <div class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg overflow-y-auto max-h-[90vh]">
            <h2 class="text-lg font-semibold mb-4">Add Proposal</h2>
            <form id="addProposalForm" method="POST" action="{% url 'administrator_proposals_add_url' %}" enctype="multipart/form-data" class="space-y-3" @submit="$event.target.querySelector('button[type=submit]').disabled = true; $event.target.querySelector('button[type=submit]').textContent = 'Saving...'">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium">Title <span class="text-red-500">*</span></label>
                    <input type="text" name="title" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Description</label>
                    <textarea name="description" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                </div>
                
                <!-- Proponent Selection -->
                <div>
                    <label class="block text-sm font-medium">Proponent</label>
                    <select name="proponent" class="w-full border rounded-lg px-3 py-2">
                        <option value="">Select Proponent</option>
                        {% for proponent in proponents %}
                        <option value="{{ proponent.id }}">{{ proponent.full_name }} ({{ proponent.email }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Beneficiary Selection -->
                <div>
                    <label class="block text-sm font-medium">Beneficiary</label>
                    <select name="beneficiary" class="w-full border rounded-lg px-3 py-2">
                        <option value="">Select Beneficiary</option>
                        {% for beneficiary in beneficiaries_list %}
                        <option value="{{ beneficiary.id }}">{{ beneficiary.full_name }} ({{ beneficiary.email }})</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Select the primary beneficiary for this proposal</p>
                </div>
                
                <!-- Location Fields -->
                <div class="border-t pt-3 mt-3">
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Project Location</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium">Municipality</label>
                            <select name="municipality" @change="updateMapFromMunicipality($event.target.value)" class="w-full border rounded-lg px-3 py-2">
                                <option value="">-- Select Municipality --</option>
                                <option value="Almeria">Almeria</option>
                                <option value="Biliran">Biliran</option>
                                <option value="Cabucgayan">Cabucgayan</option>
                                <option value="Caibiran">Caibiran</option>
                                <option value="Culaba">Culaba</option>
                                <option value="Kawayan">Kawayan</option>
                                <option value="Maripipi">Maripipi</option>
                                <option value="Naval">Naval</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Province</label>
                            <input type="text" name="province" value="Biliran" readonly class="w-full border rounded-lg px-3 py-2 bg-gray-100 cursor-not-allowed">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-sm font-medium">Specific Location/Address</label>
                        <input type="text" name="location" class="w-full border rounded-lg px-3 py-2" placeholder="Barangay, street, or specific address">
                    </div>
                    
                    <!-- Interactive Map for Location Pinning -->
                    <div class="mt-3 border rounded-lg overflow-hidden">
                        <div class="bg-gray-100 px-3 py-2 border-b flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">üìç Pin Project Location (Click or drag marker)</span>
                            <button type="button" onclick="centerMap()" class="text-xs text-blue-600 hover:text-blue-800">Reset to Center</button>
                        </div>
                        <div id="addProposalMap" style="height: 250px; width: 100%;"></div>
                    </div>
                    
                    <!-- Hidden inputs for coordinates -->
                    <div class="grid grid-cols-2 gap-3 mt-2">
                        <div>
                            <label class="block text-sm font-medium">Latitude</label>
                            <input type="text" name="latitude" readonly class="w-full border rounded-lg px-3 py-2 bg-gray-50 text-sm text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Longitude</label>
                            <input type="text" name="longitude" readonly class="w-full border rounded-lg px-3 py-2 bg-gray-50 text-sm text-gray-600">
                        </div>
                    </div>
                </div>
                
                <!-- Financial Fields -->
                <div class="border-t pt-3 mt-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium">Proposed Amount</label>
                            <input type="number" step="0.01" name="proposed_amount" class="w-full border rounded-lg px-3 py-2" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Budget Source</label>
                            <select name="budget" class="w-full border rounded-lg px-3 py-2">
                                <option value="">Select Budget</option>
                                {% for budget in budgets %}
                                <option value="{{ budget.id }}">{{ budget.fund_source }} ({{ budget.fiscal_year }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium">Supporting Documents <span class="text-gray-500 text-xs">(Multiple files allowed)</span></label>
                    <input type="file" name="documents" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" multiple class="w-full border rounded-lg px-3 py-2">
                    <p class="text-xs text-gray-500 mt-1">Supported: PDF, Word, Excel, Images</p>
                </div>
                <div class="flex justify-end gap-2 pt-3 border-t">
                    <button type="button" onclick="document.getElementById('addProposalModal').style.display='none'" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Proposal</button>
                </div>
            </form>
        </div>
    </div>
    </div>

    <!-- Edit Proposal Modal -->
    <div id="editProposalModal" style="display: none;" onclick="if(event.target === this) this.style.display='none'" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto z-50" style="padding: 2rem 0;">
        <div class="flex items-center justify-center min-h-full">
            <div class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg overflow-y-auto max-h-[90vh]">
                <h2 class="text-lg font-semibold mb-4">Edit Proposal</h2>
                <form id="editProposalForm" method="POST" enctype="multipart/form-data" class="space-y-3">
                    {% csrf_token %}
                    <div>
                        <label class="block text-sm font-medium">Title <span class="text-red-500">*</span></label>
                        <input type="text" id="editTitle" name="title" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Description</label>
                        <textarea id="editDescription" name="description" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                    </div>

                    <!-- Proponent Selection -->
                    <div>
                        <label class="block text-sm font-medium">Proponent</label>
                        <select id="editProponent" name="proponent" class="w-full border rounded-lg px-3 py-2">
                            <option value="">Select Proponent</option>
                            {% for proponent in proponents %}
                            <option value="{{ proponent.id }}">{{ proponent.full_name }} ({{ proponent.email }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Beneficiary Selection -->
                    <div>
                        <label class="block text-sm font-medium">Beneficiary</label>
                        <select id="editBeneficiary" name="beneficiary" class="w-full border rounded-lg px-3 py-2">
                            <option value="">Select Beneficiary</option>
                            {% for beneficiary in beneficiaries_list %}
                            <option value="{{ beneficiary.id }}">{{ beneficiary.full_name }} ({{ beneficiary.email }})</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select the primary beneficiary for this proposal</p>
                    </div>

                    <!-- Location Fields -->
                    <div class="border-t pt-3 mt-3">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Project Location</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium">Municipality</label>
                                <select id="editMunicipality" name="municipality" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">-- Select Municipality --</option>
                                    <option value="Almeria">Almeria</option>
                                    <option value="Biliran">Biliran</option>
                                    <option value="Cabucgayan">Cabucgayan</option>
                                    <option value="Caibiran">Caibiran</option>
                                    <option value="Culaba">Culaba</option>
                                    <option value="Kawayan">Kawayan</option>
                                    <option value="Maripipi">Maripipi</option>
                                    <option value="Naval">Naval</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Province</label>
                                <input type="text" name="province" value="Biliran" readonly class="w-full border rounded-lg px-3 py-2 bg-gray-100 cursor-not-allowed">
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="block text-sm font-medium">Specific Location/Address</label>
                            <input type="text" id="editLocation" name="location" class="w-full border rounded-lg px-3 py-2" placeholder="Barangay, street, or specific address">
                        </div>
                    </div>

                    <!-- Financial Fields -->
                    <div class="border-t pt-3 mt-3">
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium">Proposed Amount</label>
                                <input type="number" id="editProposedAmount" step="0.01" name="proposed_amount" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Approved Amount</label>
                                <input type="number" id="editApprovedAmount" step="0.01" name="approved_amount" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Budget Source</label>
                                <select id="editBudget" name="budget" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">Select Budget</option>
                                    {% for budget in budgets %}
                                    <option value="{{ budget.id }}">{{ budget.fund_source }} ({{ budget.fiscal_year }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium">Status</label>
                        <select id="editStatus" name="status" class="w-full border rounded-lg px-3 py-2">
                            <option value="pending">Pending</option>
                            <option value="for_review">For Review</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="needs_revision">Needs Revision</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Add More Documents <span class="text-gray-500 text-xs">(Multiple files allowed)</span></label>
                        <input type="file" name="documents" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" multiple class="w-full border rounded-lg px-3 py-2">
                        <p class="text-xs text-gray-500 mt-1">New files will be added to existing documents</p>
                    </div>
                    <div class="flex justify-end gap-2 pt-3 border-t">
                        <button type="button" onclick="document.getElementById('editProposalModal').style.display='none'" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Update Proposal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Proposal Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl w-11/12 md:w-1/2 shadow-xl overflow-hidden">
            <div class="bg-red-600 text-white px-6 py-4">
                <h2 class="text-2xl font-bold">Delete Proposal</h2>
            </div>
            <form id="deleteForm" method="POST" action="">
                {% csrf_token %}
                <input type="hidden" name="proposal_id" id="deleteProposalId">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="font-semibold block mb-1">Title</label>
                        <p id="deleteModalTitle" class="text-left text-justify font-bold"></p>
                    </div>
                    <div>
                        <label class="font-semibold block mb-1">Are you sure you want to delete this proposal?</label>
                        <p class="text-gray-600">This action cannot be undone.</p>
                    </div>
                </div>
                <div class="flex justify-end gap-3 px-6 py-4 bg-gray-50">
                    <button type="button" id="closeDeleteModal" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mass Delete Confirmation Modal -->
    <div x-show="openMassDelete" x-transition
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        x-cloak>
        <div @click.away="openMassDelete = false"
            class="bg-white w-full max-w-md p-6 rounded-lg shadow-lg">
            <div class="flex items-center gap-3 mb-4">
                <div class="flex-shrink-0 bg-red-100 rounded-full p-2">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h2 class="text-lg font-semibold text-gray-900">Delete Multiple Proposals</h2>
            </div>
            <p class="text-gray-600 mb-4">Are you sure you want to delete <strong x-text="selectedIds.length"></strong> proposal(s)? This action cannot be undone.</p>
            <form method="POST" action="{% url 'administrator_proposals_mass_delete_url' %}">
                {% csrf_token %}
                <template x-for="id in selectedIds" :key="id">
                    <input type="hidden" name="ids" :value="id">
                </template>
                <div class="flex justify-end gap-2">
                    <button type="button" @click="openMassDelete = false"
                        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete All</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Details Modal -->
    <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto">
        <div class="bg-white w-full max-w-4xl mx-4 my-8 rounded-lg shadow-xl overflow-hidden max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="bg-blue-600 text-white px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h2 id="projectModalTitle" class="text-xl font-bold">Project Details</h2>
                </div>
                <button onclick="closeProjectModal()" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <!-- Project ID and Status -->
                <div class="flex justify-between items-center mb-6">
                    <span id="projectModalId" class="text-sm text-gray-600"></span>
                    <span id="projectModalStatus" class="text-sm font-medium"></span>
                </div>

                <!-- Basic Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                            </svg>
                            Basic Information
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Program:</span>
                                <span id="projectModalProgram" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Type:</span>
                                <span id="projectModalType" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Fund Source:</span>
                                <span id="projectModalFundSource" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Project Leader:</span>
                                <span id="projectModalLeader" class="font-medium">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Location -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Location
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Municipality:</span>
                                <span id="projectModalMunicipality" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Province:</span>
                                <span id="projectModalProvince" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">District:</span>
                                <span id="projectModalDistrict" class="font-medium">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Beneficiaries -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                        </svg>
                        Beneficiaries
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="projectModalMale">0</div>
                            <div class="text-sm text-gray-600">Male</div>
                        </div>
                        <div class="text-center p-3 bg-pink-50 rounded-lg">
                            <div class="text-2xl font-bold text-pink-600" id="projectModalFemale">0</div>
                            <div class="text-sm text-gray-600">Female</div>
                        </div>
                        <div class="text-center p-3 bg-yellow-50 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600" id="projectModalSenior">0</div>
                            <div class="text-sm text-gray-600">Senior Citizen</div>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="projectModalPwd">0</div>
                            <div class="text-sm text-gray-600">PWD</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg md:col-span-1">
                            <div class="text-2xl font-bold text-gray-600" id="projectModalTotalBeneficiaries">0</div>
                            <div class="text-sm text-gray-600">Total</div>
                        </div>
                    </div>
                </div>

                <!-- Financial Information -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                        </svg>
                        Financial Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-green-50 rounded-lg">
                            <div class="text-sm text-gray-600">Total Funds</div>
                            <div class="text-xl font-bold text-green-600" id="projectModalFunds">‚Ç±0.00</div>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="text-sm text-gray-600">Funds Released</div>
                            <div class="text-xl font-bold text-blue-600" id="projectModalFundsReleased">‚Ç±0.00</div>
                        </div>
                        <div class="p-4 bg-orange-50 rounded-lg">
                            <div class="text-sm text-gray-600">Amount Liquidated</div>
                            <div class="text-xl font-bold text-orange-600" id="projectModalLiquidated">‚Ç±0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Timeline
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="text-sm text-gray-600">Start Date</div>
                            <div class="text-lg font-semibold text-blue-600" id="projectModalStart">-</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg">
                            <div class="text-sm text-gray-600">End Date</div>
                            <div class="text-lg font-semibold text-red-600" id="projectModalEnd">-</div>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div id="projectModalAdditional" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                        </svg>
                        Additional Information
                    </h3>
                    <div class="space-y-4">
                        <div id="projectModalContact" class="hidden">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <div class="text-sm font-medium text-gray-700 mb-2">Contact Details</div>
                                <div id="projectModalContactDetails" class="text-gray-800"></div>
                            </div>
                        </div>
                        <div id="projectModalProponent" class="hidden">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <div class="text-sm font-medium text-gray-700 mb-2">Proponent Details</div>
                                <div id="projectModalProponentDetails" class="text-gray-800"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end gap-3 px-6 py-4 bg-gray-50">
                <button onclick="closeProjectModal()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">
                    Close
                </button>
            </div>
        </div>
    </div>

</div>

<!-- Project Details Modal -->
<div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto">
    <div class="bg-white w-full max-w-4xl mx-4 rounded-lg shadow-xl overflow-hidden max-h-[90vh] flex flex-col">
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 flex-shrink-0">
            <div class="flex justify-between items-start">
                <div>
                    <h2 id="projectModalTitle" class="text-2xl font-bold">Project Details</h2>
                    <p id="projectModalId" class="text-blue-100 mt-1">Project ID: </p>
                </div>
                <div class="text-right">
                    <span id="projectModalStatus" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        Completed
                    </span>
                </div>
            </div>
            <button onclick="closeProjectModal()" class="absolute top-4 right-4 text-white hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="p-6 overflow-y-auto flex-1">
            <!-- Project Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Basic Information -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Basic Information</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Program</label>
                            <p id="projectModalProgram" class="text-gray-800">-</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Type of Project</label>
                            <p id="projectModalType" class="text-gray-800">-</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Fund Source</label>
                            <p id="projectModalFundSource" class="text-gray-800">-</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Project Leader</label>
                            <p id="projectModalLeader" class="text-gray-800">-</p>
                        </div>
                    </div>
                </div>

                <!-- Location Information -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Location</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Municipality</label>
                            <p id="projectModalMunicipality" class="text-gray-800">-</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Province</label>
                            <p id="projectModalProvince" class="text-gray-800">-</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">District</label>
                            <p id="projectModalDistrict" class="text-gray-800">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Beneficiaries -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Beneficiaries</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div id="projectModalMale" class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-sm text-gray-600">Male</div>
                    </div>
                    <div class="text-center">
                        <div id="projectModalFemale" class="text-2xl font-bold text-pink-600">0</div>
                        <div class="text-sm text-gray-600">Female</div>
                    </div>
                    <div class="text-center">
                        <div id="projectModalSenior" class="text-2xl font-bold text-purple-600">0</div>
                        <div class="text-sm text-gray-600">Senior Citizens</div>
                    </div>
                    <div class="text-center">
                        <div id="projectModalPwd" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-sm text-gray-600">PWD</div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">Total Beneficiaries</span>
                        <span id="projectModalTotalBeneficiaries" class="text-lg font-bold text-gray-800">0</span>
                    </div>
                </div>
            </div>

            <!-- Financial Information -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Financial Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-white rounded border">
                        <div class="text-sm text-gray-600">Allocated Funds</div>
                        <div id="projectModalFunds" class="text-xl font-bold text-blue-600">‚Ç±0.00</div>
                    </div>
                    <div class="text-center p-4 bg-white rounded border">
                        <div class="text-sm text-gray-600">Funds Released</div>
                        <div id="projectModalFundsReleased" class="text-xl font-bold text-green-600">‚Ç±0.00</div>
                    </div>
                    <div class="text-center p-4 bg-white rounded border">
                        <div class="text-sm text-gray-600">Amount Liquidated</div>
                        <div id="projectModalLiquidated" class="text-xl font-bold text-orange-600">‚Ç±0.00</div>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Timeline</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-gray-600">Project Start</label>
                        <p id="projectModalStart" class="text-gray-800">-</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-600">Project End</label>
                        <p id="projectModalEnd" class="text-gray-800">-</p>
                    </div>
                </div>
            </div>

            </div>
        </div>

        <div class="flex justify-end p-6 border-t border-gray-200 bg-gray-50">
            <button onclick="closeProjectModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-medium px-4 py-2 rounded-lg">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Data Visualizations Section -->
<div class="container mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Proposal Status Chart -->
    <div class="bg-white shadow-md rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3 text-gray-700">Proposal Status Distribution</h3>
        <canvas id="proposalStatusChart" class="w-full" style="max-height: 300px;"></canvas>
    </div>

    <!-- Proposed Amounts Chart -->
    <div class="bg-white shadow-md rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3 text-gray-700">Top Proposals by Amount</h3>
        <canvas id="proposalAmountsChart" class="w-full" style="max-height: 300px;"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function initMap() {
    if (window.addMap) return; // Already initialized
    const mapContainer = document.getElementById('addProposalMap');
    if (!mapContainer) return;
    
    const defaultLat = 11.55;
    const defaultLng = 124.47;
    
    window.addMap = L.map('addProposalMap').setView([defaultLat, defaultLng], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(window.addMap);
    
    window.addMarker = L.marker([defaultLat, defaultLng], {draggable: true}).addTo(window.addMap);
    
    // Update coordinates when marker is dragged
    window.addMarker.on('dragend', (e) => {
        const pos = e.target.getLatLng();
        document.querySelector('input[name="latitude"]').value = pos.lat.toFixed(6);
        document.querySelector('input[name="longitude"]').value = pos.lng.toFixed(6);
        updateLocationFromPin(pos.lat, pos.lng);
    });
    
    // Click on map to move marker
    window.addMap.on('click', (e) => {
        window.addMarker.setLatLng(e.latlng);
        document.querySelector('input[name="latitude"]').value = e.latlng.lat.toFixed(6);
        document.querySelector('input[name="longitude"]').value = e.latlng.lng.toFixed(6);
        updateLocationFromPin(e.latlng.lat, e.latlng.lng);
    });
    
    // Set initial coordinates
    document.querySelector('input[name="latitude"]').value = defaultLat.toFixed(6);
    document.querySelector('input[name="longitude"]').value = defaultLng.toFixed(6);
}

function updateLocationFromPin(lat, lng) {
    const locationField = document.querySelector('input[name="location"]');
    if (locationField && (!locationField.value || locationField.value.trim() === '')) {
        // Show loading text while fetching address
        locationField.value = 'Getting address...';
        
        // Use Nominatim (OpenStreetMap) for reverse geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    // Extract a readable address from the response
                    let address = data.display_name;
                    
                    // Try to get a more concise address
                    if (data.address) {
                        const addr = data.address;
                        const parts = [];
                        if (addr.house_number) parts.push(addr.house_number);
                        if (addr.road) parts.push(addr.road);
                        if (addr.suburb || addr.neighbourhood) parts.push(addr.suburb || addr.neighbourhood);
                        if (addr.city || addr.town || addr.village) parts.push(addr.city || addr.town || addr.village);
                        if (addr.state) parts.push(addr.state);
                        
                        if (parts.length > 0) {
                            address = parts.join(', ');
                        }
                    }
                    
                    locationField.value = address;
                } else {
                    // Fallback to coordinates if geocoding fails
                    locationField.value = `üìç Pinned Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
            })
            .catch(error => {
                console.error('Geocoding error:', error);
                // Fallback to coordinates if geocoding fails
                locationField.value = `üìç Pinned Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            });
    }
}

function centerMap() {
    if (window.addMap && window.addMarker) {
        window.addMap.setView([11.55, 124.47], 10);
        window.addMarker.setLatLng([11.55, 124.47]);
        document.querySelector('input[name="latitude"]').value = '11.550000';
        document.querySelector('input[name="longitude"]').value = '124.470000';
    }
}

document.addEventListener("DOMContentLoaded", function () {
    // Target both proposals and budget file inputs
    const pdfInputs = document.querySelectorAll(
        "input[type='file'][name='document'], input[type='file'][name='budget_document']"
    );

    pdfInputs.forEach(input => {
        input.addEventListener("change", function () {
            const file = this.files[0];
            if (file && file.type !== "application/pdf") {
                alert("Invalid file type. Please upload a PDF only.");
                this.value = ""; // Reset invalid file
            }
        });
    });

    // Initialize Charts
    const statusLabels = {{ proposal_status_labels|safe }};
    const statusValues = {{ proposal_status_values|safe }};

    const statusCtx = document.getElementById('proposalStatusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusValues,
                backgroundColor: ['#FCD34D', '#60A5FA', '#34D399', '#F87171', '#FB923C'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    const amountLabels = {{ proposal_amount_labels|safe }};
    const amountValues = {{ proposal_amount_values|safe }};

    const amountsCtx = document.getElementById('proposalAmountsChart').getContext('2d');
    new Chart(amountsCtx, {
        type: 'bar',
        data: {
            labels: amountLabels,
            datasets: [{
                label: 'Proposed Amount (‚Ç±)',
                data: amountValues,
                backgroundColor: '#3B82F6',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‚Ç±' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
});
</script>

<script>
    // Global function to open delete modal (works with DataTables)
    window.openDeleteModal = function(id, title) {
        document.getElementById('deleteProposalId').value = id;
        document.getElementById('deleteModalTitle').innerText = title;
        const form = document.getElementById('deleteForm');
        form.action = `/administrator/proposals/delete/${id}/`;
        document.getElementById('deleteModal').classList.remove('hidden');
    };

    // Global function to open edit modal (works with DataTables)
    window.openEditModal = function(button) {
        // Populate form fields directly
        document.getElementById('editTitle').value = button.dataset.title || '';
        document.getElementById('editDescription').value = button.dataset.description || '';
        document.getElementById('editProponent').value = button.dataset.proponent || '';
        document.getElementById('editBeneficiary').value = button.dataset.beneficiary || '';
        document.getElementById('editMunicipality').value = button.dataset.municipality || '';
        document.getElementById('editLocation').value = button.dataset.location || '';
        document.getElementById('editProposedAmount').value = button.dataset.proposed_amount || '';
        document.getElementById('editApprovedAmount').value = button.dataset.approved_amount || '';
        document.getElementById('editBudget').value = button.dataset.budget || '';
        document.getElementById('editStatus').value = button.dataset.status || '';

        // Set form action URL
        const form = document.getElementById('editProposalForm');
        form.action = `/administrator/proposals/update/${button.dataset.id}/`;

        // Show modal
        document.getElementById('editProposalModal').style.display = 'block';
    };

    $(document).ready(function () {
        $('#proposalsTable').DataTable();

        // Use event delegation for DataTables compatibility
        const table = document.getElementById('proposalsTable');

        // Approve button handler (delegated)
        table.addEventListener('click', function(e) {
            const btn = e.target.closest('.approveBtn');
            if (btn) {
                const modal = document.getElementById('approveModal');
                modal.classList.remove('hidden');

                const proposalId = btn.dataset.id;
                document.getElementById('modalProposalId').value = proposalId;
                document.getElementById('modalTitle').textContent = btn.dataset.title;
                document.getElementById('modalDescription').textContent = btn.dataset.description;
                document.getElementById('modalProposedAmount').textContent = btn.dataset.proposed_amount;
                document.getElementById('modalBudget').textContent = btn.dataset.budget;

                const docLink = document.getElementById('modalDocument');
                if(btn.dataset.documentUrl) {
                    docLink.href = btn.dataset.documentUrl;
                    docLink.style.display = 'inline';
                } else {
                    docLink.style.display = 'none';
                }

                document.getElementById('project_start_date').value = '';
                document.getElementById('project_end_date').value = '';
                document.getElementById('approved_amount').value = '';

                const form = document.getElementById('approveForm');
                form.action = `/administrator/proposals/approve/${proposalId}/`;
            }
        });

        // Close approve modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('approveModal').classList.add('hidden');
        });

        // Decline button handler (delegated)
        table.addEventListener('click', function(e) {
            const btn = e.target.closest('.declineBtn');
            if (btn) {
                const proposalId = btn.dataset.id;
                const title = btn.dataset.title;

                document.getElementById('declineProposalId').value = proposalId;
                document.getElementById('declineModalTitle').innerText = title;

                document.getElementById('declineModal').classList.remove('hidden');
            }
        });

        // Close decline modal
        document.getElementById('closeDeclineModal').addEventListener('click', () => {
            document.getElementById('declineModal').classList.add('hidden');
        });

        // Remarks button handler (delegated)
        table.addEventListener('click', function(e) {
            const btn = e.target.closest('.remarksBtn');
            if (btn) {
                const remarks = btn.dataset.remarks;
                document.getElementById('modalRemarksContent').innerText = remarks;
                document.getElementById('remarksModal').classList.remove('hidden');
            }
        });

        // Close remarks modal
        document.getElementById('closeRemarksModal').addEventListener('click', () => {
            document.getElementById('remarksModal').classList.add('hidden');
        });

        // Close delete modal
        document.getElementById('closeDeleteModal').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.add('hidden');
        });

        // Set delete form action when modal opens
        window.addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                document.getElementById('deleteModal').classList.add('hidden');
            }
        });

        // Project modal functions
        window.openProjectModal = function(projectData) {
            populateProjectModal(projectData);
        };

        function populateProjectModal(project) {
            // Basic info
            document.getElementById('projectModalTitle').textContent = project.project_title || 'Project Details';
            document.getElementById('projectModalId').textContent = 'Project ID: ' + (project.id || '');
            
            // Status
            const statusElement = document.getElementById('projectModalStatus');
            statusElement.textContent = project.status || 'Unknown';
            statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium';
            
            if (project.status === 'completed') {
                statusElement.classList.add('bg-green-100', 'text-green-800');
            } else if (project.status === 'ongoing') {
                statusElement.classList.add('bg-blue-100', 'text-blue-800');
            } else if (project.status === 'approved') {
                statusElement.classList.add('bg-yellow-100', 'text-yellow-800');
            } else {
                statusElement.classList.add('bg-gray-100', 'text-gray-800');
            }
            
            // Basic information
            document.getElementById('projectModalProgram').textContent = project.program || '-';
            document.getElementById('projectModalType').textContent = project.type_of_project || '-';
            document.getElementById('projectModalFundSource').textContent = project.fund_source || '-';
            document.getElementById('projectModalLeader').textContent = project.project_leader ? project.project_leader.get_full_name : '-';
            
            // Location
            document.getElementById('projectModalMunicipality').textContent = project.mun || '-';
            document.getElementById('projectModalProvince').textContent = project.province || '-';
            document.getElementById('projectModalDistrict').textContent = project.district || '-';
            
            // Beneficiaries
            document.getElementById('projectModalMale').textContent = project.male || 0;
            document.getElementById('projectModalFemale').textContent = project.female || 0;
            document.getElementById('projectModalSenior').textContent = project.senior_citizen || 0;
            document.getElementById('projectModalPwd').textContent = project.pwd || 0;
            document.getElementById('projectModalTotalBeneficiaries').textContent = project.no_of_beneficiaries || 0;
            
            // Financial
            document.getElementById('projectModalFunds').textContent = '‚Ç±' + (project.funds ? parseFloat(project.funds).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00');
            document.getElementById('projectModalFundsReleased').textContent = '‚Ç±' + (project.total_funds_released ? parseFloat(project.total_funds_released).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00');
            document.getElementById('projectModalLiquidated').textContent = '‚Ç±' + (project.amount_liquidated ? parseFloat(project.amount_liquidated).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00');
            
            // Timeline
            document.getElementById('projectModalStart').textContent = project.project_start ? new Date(project.project_start).toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'}) : '-';
            document.getElementById('projectModalEnd').textContent = project.project_end ? new Date(project.project_end).toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'}) : '-';
            
            // Show modal
            document.getElementById('projectModal').classList.remove('hidden');
        }

        window.closeProjectModal = function() {
            document.getElementById('projectModal').classList.add('hidden');
        };

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('projectModal');
            if (e.target === modal) {
                closeProjectModal();
            }
        });
    });
</script>

{% endblock %}
