{% extends "administrator/base.html" %}
{% load static %}

{% block title %}Staff Assignments{% endblock %}
{% block nav-tasks %}active-nav{% endblock %}
{% block page-title %}Staff Assignments{% endblock %}

{% block content %}
<!-- jQuery, DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<!-- LeafletJS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Custom styles for table and scrollbar -->
<style>
    .table-scroll-container {
        overflow-x: auto;
        max-width: 100%;
    }
    .table-scroll-container::-webkit-scrollbar {
        height: 8px;
    }
    .table-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    .table-scroll-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    .table-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    #tasksTable {
        width: 100% !important;
    }
    #tasksTable th, #tasksTable td {
        white-space: nowrap;
    }
    .dataTables_wrapper {
        overflow-x: visible !important;
    }
</style>

<!-- Task Manager Component - must be defined before Alpine initializes -->
<script>
function taskManager() {
    return {
        openAdd: false,
        openEdit: false,
        openDelete: false,
        openViewMap: false,
        editTask: {},
        deleteTask: { id: null, title: '' },
        mapTask: {},
        viewMapInstance: null,
        deleteFormActionBase: '/administrator/tasks/delete/',

        init() {
            console.log('taskManager initialized');
        },

        initTable() {
            if (typeof $ !== 'undefined' && $.fn.DataTable) {
                $('#tasksTable').DataTable();
            }
        },

        initAdd() {
            // Auto-fill location when project is selected - no map needed
        },

        openEditModal(task) {
            this.editTask = task;
            this.openEdit = true;
        },

        openViewMapModal(title, lat, lng, projectTitle) {
            console.log('openViewMapModal called with:', { title, lat, lng, projectTitle });
            
            const latitude = (lat && lat !== '' && lat !== 'None') ? parseFloat(lat) : null;
            const longitude = (lng && lng !== '' && lng !== 'None') ? parseFloat(lng) : null;
            
            this.mapTask = { 
                title: title, 
                latitude: latitude, 
                longitude: longitude,
                projectTitle: projectTitle || ''
            };
            this.openViewMap = true;

            const self = this;
            setTimeout(function() {
                self.initViewMap(latitude, longitude, title, projectTitle);
            }, 200);
        },
        
        destroyViewMap() {
            if (this.viewMapInstance) {
                try {
                    this.viewMapInstance.remove();
                } catch(e) {
                    console.error('Error removing map:', e);
                }
                this.viewMapInstance = null;
            }
        },

        openDeleteModal(id, title) {
            console.log('openDeleteModal called with:', { id, title });
            this.deleteTask = { id: id, title: title };
            this.openDelete = true;
            
            const self = this;
            setTimeout(function() {
                const form = document.getElementById('deleteTaskForm');
                if (form) {
                    form.action = self.deleteFormActionBase + id + '/';
                    console.log('Delete form action set to:', form.action);
                }
            }, 50);
        },

        initViewMap(lat, lng, taskTitle, projectTitle) {
            this.destroyViewMap();
            
            const mapContainer = document.getElementById('viewMap');
            if (!mapContainer) {
                console.error('Map container not found');
                return;
            }
            
            mapContainer.innerHTML = '';
            
            const defaultLat = 11.5833;
            const defaultLng = 124.4667;
            
            const hasValidCoords = lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng);
            const finalLat = hasValidCoords ? lat : defaultLat;
            const finalLng = hasValidCoords ? lng : defaultLng;
            
            console.log('Initializing map at:', finalLat, finalLng, 'Valid coords:', hasValidCoords);
            
            try {
                this.viewMapInstance = L.map('viewMap').setView([finalLat, finalLng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(this.viewMapInstance);

                if (hasValidCoords) {
                    const popupContent = '<strong>' + taskTitle + '</strong><br><small>Project: ' + projectTitle + '</small>';
                    L.marker([lat, lng]).addTo(this.viewMapInstance).bindPopup(popupContent).openPopup();
                } else {
                    L.popup()
                        .setLatLng([finalLat, finalLng])
                        .setContent('<strong>No location set</strong><br><small>Default: Biliran Province</small>')
                        .openOn(this.viewMapInstance);
                }

                const mapInstance = this.viewMapInstance;
                setTimeout(function() {
                    if (mapInstance) {
                        mapInstance.invalidateSize();
                    }
                }, 300);
            } catch (e) {
                console.error('Failed to initialize map:', e);
            }
        }
    };
}
</script>

<div class="container mt-2"
     x-data="taskManager()"
     x-init="init(); initTable()">

    <!-- Flash Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-3 rounded-lg text-white {% if message.tags == 'success' %}bg-green-500{% elif message.tags == 'error' %}bg-red-500{% else %}bg-blue-500{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Page Header -->
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800 flex items-center">
            Staff Assignments
            <span class="tooltip-container ml-2">
                <span class="tooltip-icon">?</span>
                <span class="tooltip-text">Assign staff members to specific projects with defined roles and responsibilities. Track task progress and manage project team assignments across all active projects.</span>
            </span>
        </h2>
    </div>

    <!-- Add Assignment Button -->
    <div class="flex justify-end mb-4">
        <button @click="openAdd = true; initAdd();"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg shadow">
            + Assign Staff
        </button>
    </div>

    <!-- Staff Assignments Table -->
    <div class="bg-white shadow-md rounded-lg p-4">
        <div class="table-scroll-container">
            <table id="tasksTable" class="min-w-full text-sm text-left text-gray-600">
                <thead class="bg-gray-100 text-gray-700 sticky top-0">
                    <tr>
                        <th class="px-3 py-2 text-center">Actions</th>
                        <th class="px-3 py-2">#</th>
                        <th class="px-3 py-2">Project</th>
                        <th class="px-3 py-2">Description</th>
                        <th class="px-3 py-2">Priority</th>
                        <th class="px-3 py-2">Category</th>
                        <th class="px-3 py-2">Location</th>
                        <th class="px-3 py-2">Assigned Staff</th>
                        <th class="px-3 py-2">Start Date</th>
                        <th class="px-3 py-2">Due Date</th>
                        <th class="px-3 py-2">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 text-center">
                        <div class="flex justify-center gap-1">
                            <!-- Edit -->
                            <button type="button"
                                title="Edit"
                                @click="openEditModal({
                                    id: {{ task.id }},
                                    project: {{ task.project.id }},
                                    title: `{{ task.title|escapejs }}`,
                                    description: `{{ task.description|escapejs|default:'' }}`,
                                    assigned_to: {{ task.assigned_to.id|default:'null' }},
                                    start_date: '{{ task.start_date|date:'Y-m-d'|default:'' }}',
                                    due_date: '{{ task.due_date|date:'Y-m-d'|default:'' }}',
                                    priority: '{{ task.priority|default:'medium' }}',
                                    category: '{{ task.category|default:'other' }}',
                                    status: '{{ task.status|default:'pending' }}',
                                    progress_percentage: {{ task.progress_percentage|default:0 }},
                                    actual_hours: '{{ task.actual_hours|default:'' }}',
                                    latitude: '{{ task.latitude|default:'' }}',
                                    longitude: '{{ task.longitude|default:'' }}'
                                })"
                                class="p-1.5 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>

                            <!-- Delete -->
                            <form method="POST" action="{% url 'administrator_task_delete_url' task.id %}" class="inline" 
                                  onsubmit="event.preventDefault(); if(confirm('Are you sure you want to delete this task: {{ task.title|escapejs }}?')) this.submit();">
                                {% csrf_token %}
                                <button type="submit"
                                    title="Delete"
                                    class="p-1.5 bg-red-500 text-white rounded hover:bg-red-600 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </td>
                    <td class="px-3 py-2">{{ forloop.counter }}</td>
                    <td class="px-3 py-2 max-w-[150px] truncate" title="{{ task.project.project_title }}">{{ task.project.project_title|truncatechars:25 }}</td>
                    <td class="px-3 py-2 max-w-[150px] truncate" title="{{ task.description }}">{{ task.description|truncatewords:8 }}</td>
                    <td class="px-3 py-2">
                        {% if task.priority == 'critical' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800 font-medium">Critical</span>
                        {% elif task.priority == 'high' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-orange-100 text-orange-800 font-medium">High</span>
                        {% elif task.priority == 'medium' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-yellow-100 text-yellow-800 font-medium">Medium</span>
                        {% elif task.priority == 'low' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-800 font-medium">Low</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2">
                        {% if task.category == 'planning' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-800 font-medium">Planning</span>
                        {% elif task.category == 'development' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-purple-100 text-purple-800 font-medium">Dev</span>
                        {% elif task.category == 'testing' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-pink-100 text-pink-800 font-medium">Testing</span>
                        {% elif task.category == 'documentation' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-indigo-100 text-indigo-800 font-medium">Docs</span>
                        {% elif task.category == 'review' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-teal-100 text-teal-800 font-medium">Review</span>
                        {% elif task.category == 'deployment' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-cyan-100 text-cyan-800 font-medium">Deploy</span>
                        {% elif task.category == 'maintenance' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-800 font-medium">Maint</span>
                        {% else %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-800 font-medium">Other</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 max-w-[100px] truncate">
                        {% if task.project.beneficiary_address %}
                            {{ task.project.beneficiary_address|truncatechars:20 }}
                        {% elif task.project.mun or task.project.province %}
                            {{ task.project.mun|default:"" }}{% if task.project.mun and task.project.province %}, {% endif %}{{ task.project.province|default:"" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-3 py-2">{{ task.assigned_to.full_name|truncatechars:15 }}</td>
                    <td class="px-3 py-2">{{ task.start_date|date:"m/d/y"|default:"-" }}</td>
                    <td class="px-3 py-2">{{ task.due_date|date:"m/d/y"|default:"-" }}</td>
                    <td class="px-3 py-2 text-center">
                        {% if task.status == 'pending' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-yellow-100 text-yellow-800 font-medium">Pending</span>
                        {% elif task.status == 'in_progress' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-800 font-medium">In Progress</span>
                        {% elif task.status == 'completed' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-800 font-medium">Completed</span>
                        {% elif task.status == 'delayed' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800 font-medium">Delayed</span>
                        {% elif task.status == 'on_track' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-800 font-medium">On Track</span>
                        {% elif task.status == 'behind_schedule' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-orange-100 text-orange-800 font-medium">Behind</span>
                        {% elif task.status == 'at_risk' %}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800 font-medium">At Risk</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>

    <!-- Add Modal -->
    <div x-show="openAdd" x-transition
         class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto" x-cloak>
        <div @click.away="openAdd = false"
             class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg mt-10 mb-10 overflow-y-auto max-h-[90vh]">
            <h2 class="text-lg font-semibold mb-4">Add Task</h2>
            <form method="POST" action="{% url 'administrator_task_create_url' %}">
                {% csrf_token %}
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium">Project</label>
                        <select name="project" id="addProjectSelect" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Select Project</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.project_title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Description</label>
                        <textarea name="description" class="w-full border rounded-lg px-3 py-2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Assigned To</label>
                        <select name="assigned_to" class="w-full border rounded-lg px-3 py-2">
                            <option value="">Select User</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium">Priority</label>
                        <select name="priority" class="w-full border rounded-lg px-3 py-2">
                            {% for value, label in priority_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium">Category</label>
                        <select name="category" class="w-full border rounded-lg px-3 py-2">
                            {% for value, label in category_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Start Date</label>
                        <input type="date" name="start_date" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Due Date</label>
                        <input type="date" name="due_date" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Progress Percentage (0-100)</label>
                        <input type="number" name="progress_percentage" min="0" max="100" value="0" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Actual Hours</label>
                        <input type="number" step="0.5" name="actual_hours" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., 6.0">
                    </div>

                    <div class="flex justify-end gap-2 pt-3">
                        <button type="button" @click="openAdd = false" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Modal -->
    <div x-show="openEdit" x-transition
         class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto" x-cloak>
        <div @click.away="openEdit = false"
             class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg mt-10 mb-10 overflow-y-auto max-h-[90vh]">
            <h2 class="text-lg font-semibold mb-4">Edit Task</h2>
            <form method="POST" action="{% url 'administrator_task_edit_url' %}">
                {% csrf_token %}
                <input type="hidden" name="id" :value="editTask.id">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium">Project</label>
                        <select name="project" x-model="editTask.project" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Select Project</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.project_title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium">Assigned To</label>
                        <select name="assigned_to" x-model="editTask.assigned_to" class="w-full border rounded-lg px-3 py-2">
                            <option value="">Select User</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium">Description</label>
                        <textarea name="description" x-model="editTask.description" class="w-full border rounded-lg px-3 py-2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Status</label>
                        <select name="status" x-model="editTask.status" class="w-full border rounded-lg px-3 py-2">
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="delayed">Delayed</option>
                            <option value="on_track">On Track</option>
                            <option value="behind_schedule">Behind Schedule</option>
                            <option value="at_risk">At Risk</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium">Priority</label>
                        <select name="priority" x-model="editTask.priority" class="w-full border rounded-lg px-3 py-2">
                            {% for value, label in priority_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium">Category</label>
                        <select name="category" x-model="editTask.category" class="w-full border rounded-lg px-3 py-2">
                            {% for value, label in category_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Start Date</label>
                        <input type="date" name="start_date" x-model="editTask.start_date" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Due Date</label>
                        <input type="date" name="due_date" x-model="editTask.due_date" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Progress Percentage (0-100)</label>
                        <input type="number" name="progress_percentage" min="0" max="100" x-model="editTask.progress_percentage" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Actual Hours</label>
                        <input type="number" step="0.5" name="actual_hours" x-model="editTask.actual_hours" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., 6.0">
                    </div>
                    </div>

                    <div class="flex justify-end gap-2 pt-3">
                        <button type="button" @click="openEdit = false" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Update</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Task Modal -->
    <div x-show="openDelete" x-transition
         class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
         x-cloak>
        <div @click.away="openDelete = false"
             class="bg-white w-full max-w-md p-6 rounded-lg shadow-lg">
            <div class="flex items-center gap-3 mb-4">
                <div class="flex-shrink-0 bg-red-100 rounded-full p-2">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h2 class="text-lg font-semibold text-gray-900">Delete Task</h2>
            </div>
            <p class="text-gray-600 mb-2">Are you sure you want to delete this task?</p>
            <p class="text-gray-800 font-medium mb-4" x-text="deleteTask.title"></p>
            <p class="text-red-600 text-sm mb-4">This action cannot be undone.</p>
            <form method="POST" id="deleteTaskForm" x-bind:action="'/administrator/tasks/delete/' + deleteTask.id + '/'">
                {% csrf_token %}
                <div class="flex justify-end gap-2">
                    <button type="button" @click="openDelete = false"
                        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Map Modal -->
    <div x-show="openViewMap" x-transition
         class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto" x-cloak>
        <div @click.away="openViewMap = false; destroyViewMap();"
             class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg mt-10 mb-10 overflow-y-auto max-h-[90vh]">
            <h2 class="text-lg font-semibold mb-4" x-text="'Location: ' + (mapTask.title || 'Task')"></h2>
            <div id="viewMap" class="w-full h-80 rounded-lg border"></div>
            <div class="flex justify-end mt-4">
                <button type="button" @click="openViewMap = false; destroyViewMap();" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

</div>

{% endblock %}
