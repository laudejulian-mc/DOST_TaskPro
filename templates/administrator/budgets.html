{% extends "administrator/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Budget Management{% endblock %}
{% block nav-budgets %}active-nav{% endblock %}
{% block page-title %}Budget Management{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js" defer></script>

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-2" x-data="{ openAdd: false, openEdit: false, editBudget: {} }">

    <!-- Flash Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-3 rounded-lg text-white 
                        {% if message.tags == 'success' %} bg-green-500 
                        {% elif message.tags == 'error' %} bg-red-500 
                        {% else %} bg-blue-500 {% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Summary Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow">
            <div class="text-2xl font-bold">‚Ç±{{ total_budget|floatformat:0|intcomma }}</div>
            <div class="text-sm opacity-90">Total Equipment Value</div>
        </div>
        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow">
            <div class="text-2xl font-bold">‚Ç±{{ total_spent|floatformat:0|intcomma }}</div>
            <div class="text-sm opacity-90">Equipment Delivered</div>
        </div>
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow">
            <div class="text-2xl font-bold">‚Ç±{{ total_remaining|floatformat:0|intcomma }}</div>
            <div class="text-sm opacity-90">Pending Delivery</div>
        </div>
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow">
            <div class="text-2xl font-bold">{{ utilization_rate|floatformat:1 }}%</div>
            <div class="text-sm opacity-90">Delivery Rate</div>
        </div>
        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-4 rounded-lg shadow">
            <div class="text-2xl font-bold">{{ budget_count }}</div>
            <div class="text-sm opacity-90">Active Budgets</div>
        </div>
    </div>

    {% if selected_fund != 'all' %}
    <!-- Filter Notice -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-blue-700">
                    <strong>Filter Active:</strong> Showing data for <strong>{{ selected_fund }}</strong>. All statistics and charts below reflect this fund source only.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Fund Filter -->
    <div class="bg-white p-4 rounded-lg shadow mb-6">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-700">Filter by Fund Source</h3>
            <form method="GET" class="flex items-center space-x-2">
                <label for="fund" class="text-sm font-medium text-gray-600">Select Fund:</label>
                <select name="fund" id="fund" onchange="this.form.submit()" 
                        class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all" {% if selected_fund == 'all' %}selected{% endif %}>All Funds</option>
                    {% for fund_source in all_fund_sources %}
                    <option value="{{ fund_source }}" {% if selected_fund == fund_source %}selected{% endif %}>{{ fund_source }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        {% if selected_fund != 'all' %}
        <p class="text-sm text-blue-600 mt-2">Currently showing data for: <strong>{{ selected_fund }}</strong></p>
        {% endif %}
    </div>

    <!-- Data Visualizations -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <!-- Budget Status Pie Chart -->
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">Budget Status</h3>
            <div style="max-width: 200px; margin: 0 auto;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        
        <!-- Utilization by Fund Source -->
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">Allocation by Fund Source</h3>
            <canvas id="fundSourceChart" height="200"></canvas>
        </div>
        
        <!-- Allocation by Fiscal Year -->
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">Allocation by Fiscal Year</h3>
            <canvas id="fiscalYearChart" height="200"></canvas>
        </div>
    </div>

    <!-- Budget Allocation Details -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-700">Budget Allocation Details</h3>
        <p class="text-gray-600 mb-4">Detailed breakdown showing how each budget source is allocated and where funds are being used.</p>
        
        <div class="space-y-6">
            {% for allocation in budget_allocations %}
            <div class="border rounded-lg p-4">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800">{{ allocation.fund_source }} ({{ allocation.fiscal_year }})</h4>
                        <p class="text-sm text-gray-600">Budget ID: {{ allocation.budget_id }}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Total: ‚Ç±{{ allocation.total_amount|floatformat:0|intcomma }}</div>
                        <div class="text-sm text-green-600">Allocated: ‚Ç±{{ allocation.allocated_amount|floatformat:0|intcomma }}</div>
                        <div class="text-sm text-blue-600">Remaining: ‚Ç±{{ allocation.remaining_amount|floatformat:0|intcomma }}</div>
                    </div>
                </div>
                
                {% if allocation.allocations %}
                <div class="bg-gray-50 rounded p-3">
                    <h5 class="font-medium text-gray-700 mb-2">Allocations ({{ allocation.allocation_count }} items)</h5>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        {% for item in allocation.allocations %}
                        <div class="flex justify-between items-center bg-white p-2 rounded border-l-4 
                            {% if item.type == 'project' %}border-blue-500
                            {% elif item.type == 'equipment' %}border-purple-500
                            {% else %}border-green-500{% endif %}">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs px-2 py-1 rounded-full 
                                        {% if item.type == 'project' %}bg-blue-100 text-blue-700
                                        {% elif item.type == 'equipment' %}bg-purple-100 text-purple-700
                                        {% else %}bg-green-100 text-green-700{% endif %}">
                                        {{ item.type|title }}
                                    </span>
                                    {% if item.type == 'project' %}
                                        <a href="{% url 'administrator_projects_detail_url' item.id %}" 
                                           class="font-medium text-blue-600 hover:text-blue-800 hover:underline">
                                            {{ item.title|truncatewords:8 }}
                                        </a>
                                    {% else %}
                                        <span class="font-medium text-gray-800">{{ item.title|truncatewords:8 }}</span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-600 mt-1">
                                    üìç {{ item.location }} ‚Ä¢ üë§ {{ item.beneficiary }}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-gray-800">‚Ç±{{ item.amount|floatformat:0|intcomma }}</div>
                                <div class="text-xs px-2 py-1 rounded-full 
                                    {% if item.status == 'completed' or item.status == 'delivered' %}bg-green-100 text-green-700
                                    {% elif item.status == 'ongoing' or item.status == 'allocated' %}bg-blue-100 text-blue-700
                                    {% elif item.status == 'approved' %}bg-yellow-100 text-yellow-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ item.status|title }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="bg-gray-50 rounded p-3 text-center text-gray-500">
                    <p>No allocations yet for this budget source.</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Add Budget Button -->
    <div class="flex justify-end mb-4">
        <button @click="openAdd = true" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg shadow">
            + Add Budget
        </button>
    </div>

    <!-- Budgets Table -->
    <div class="overflow-x-auto bg-white shadow-md rounded-lg p-4">
        <table id="budgetsTable" class="min-w-full text-sm text-left text-gray-600">
            <thead class="bg-gray-100 text-gray-700">
                <tr>
                    <th class="px-4 py-2">#</th>
                    <th class="px-4 py-2">Fiscal Year</th>
                    <th class="px-4 py-2">Fund Source</th>
                    <th class="px-4 py-2">Equipment Value (Allocated)</th>
                    <th class="px-4 py-2">Equipment Value (Pending Delivery)</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2">Documents</th>
                    <th class="px-4 py-2 text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for budget in budgets %}
                <tr>
                    <td class="px-4 py-2">{{ forloop.counter }}</td>
                    <td class="px-4 py-2">{{ budget.fiscal_year }}</td>
                    <td class="px-4 py-2">{{ budget.fund_source }}</td>
                    <td class="px-4 py-2">{{ budget.total_amount|floatformat:0|intcomma }}</td>
                    <td class="px-4 py-2">{{ budget.remaining_amount|floatformat:0|intcomma }}</td>
                    <td class="px-4 py-2 text-center">
                        {% if budget.status == 'pending_procurement' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800 font-medium">Pending Procurement</span>
                        {% elif budget.status == 'available' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-green-100 text-green-800 font-medium">Available</span>
                        {% elif budget.status == 'partially_allocated' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-blue-100 text-blue-800 font-medium">Partially Allocated</span>
                        {% elif budget.status == 'fully_allocated' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-purple-100 text-purple-800 font-medium">Fully Allocated</span>
                        {% elif budget.status == 'completed' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-teal-100 text-teal-800 font-medium">Completed</span>
                        {% elif budget.status == 'archived' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-gray-100 text-gray-800 font-medium">Archived</span>
                        {% elif budget.status == 'active' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-green-100 text-green-800 font-medium">Available</span>
                        {% elif budget.status == 'exhausted' %}
                            <span class="px-2 py-1 rounded-full text-sm bg-purple-100 text-purple-800 font-medium">Fully Allocated</span>
                        {% else %}
                            <span class="px-2 py-1 rounded-full text-sm bg-gray-100 text-gray-800 font-medium">{{ budget.status|title }}</span>
                        {% endif %}
                    </td>
                    <td x-data="{ openDocs: false }" class="px-4 py-2 text-center">
                        {% if budget.documents.count > 0 %}
                            <button @click="openDocs = true" class="px-2 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 text-sm">
                                üìÑ {{ budget.documents.count }} file{{ budget.documents.count|pluralize }}
                            </button>
                            <!-- Documents Modal -->
                            <div x-show="openDocs" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" x-cloak>
                                <div @click.away="openDocs = false" class="bg-white w-full max-w-lg p-6 rounded-lg shadow-lg">
                                    <h3 class="text-lg font-semibold mb-4">Documents for {{ budget.fund_source }} ({{ budget.fiscal_year }})</h3>
                                    <ul class="space-y-2 max-h-64 overflow-y-auto">
                                        {% for doc in budget.documents.all %}
                                        <li class="flex items-center justify-between bg-gray-50 p-2 rounded">
                                            <a href="{{ doc.file.url }}" target="_blank" class="text-blue-600 hover:underline truncate flex-1">
                                                üìé {{ doc.filename }}
                                            </a>
                                            <a href="{% url 'delete_budget_document' doc.id %}" 
                                               onclick="return confirm('Delete this document?')"
                                               class="ml-2 text-red-500 hover:text-red-700 text-sm">‚úï</a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <div class="mt-4 text-right">
                                        <button @click="openDocs = false" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <span class="text-gray-400 text-sm">No files</span>
                        {% endif %}
                    </td>
                    <td x-data="{ openDelete: false, deleteId: null }" class="px-4 py-2 text-center">
                        <!-- Edit Button -->
                        <button type="button"
                                class="px-3 py-1 text-white bg-yellow-500 rounded hover:bg-yellow-600 editBtn"
                                data-id="{{ budget.id }}"
                                data-fiscal_year="{{ budget.fiscal_year }}"
                                data-fund_source="{{ budget.fund_source }}"
                                data-total_amount="{{ budget.total_amount }}"
                                data-remaining_amount="{{ budget.remaining_amount }}"
                                data-status="{{ budget.status }}">
                            Edit
                        </button>   

                        <!-- Delete Button -->
                        <button type="button"
                                class="ml-2 px-3 py-1 text-white bg-red-600 rounded hover:bg-red-700"
                                @click="openDelete = true; deleteId = {{ budget.id }}">
                            Delete
                        </button>

                        <!-- Delete Confirmation Modal -->
                        <div x-show="openDelete" x-transition x-cloak
                            class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                            <div @click.away="openDelete = false" class="bg-white w-full max-w-md p-6 rounded-lg shadow-lg">
                                <h2 class="text-lg font-semibold mb-4">Confirm Deletion</h2>
                                <p class="mb-4 text-black">Are you sure you want to delete this budget?</p>
                                
                                <div class="flex justify-end space-x-2">
                                    <button @click="openDelete = false"
                                            class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                                        Cancel
                                    </button>

                                    <form :action="`/administrator/budgets/delete/${deleteId}/`" method="POST">
                                        {% csrf_token %}
                                        <button type="submit"
                                                class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>

    <!-- Add Budget Modal -->
    <div x-show="openAdd" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto" x-cloak>
        <div @click.away="openAdd = false" class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg mt-10 mb-10 overflow-y-auto max-h-[90vh]">
            <h2 class="text-lg font-semibold mb-4">Add Budget (Equipment Allocation)</h2>
            <p class="text-sm text-gray-600 mb-4">
                <span class="material-icons text-blue-500 align-middle text-sm">info</span>
                Budgets represent equipment/material allocations from DOST. The total value is calculated from equipment items you allocate to this budget.
            </p>
            <form method="POST" action="{% url 'administrator_budgets_add_url' %}" enctype="multipart/form-data" class="space-y-3">
                {% csrf_token %}
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium">Fiscal Year <span class="text-red-500">*</span></label>
                        <input type="number" name="fiscal_year" class="w-full border rounded-lg px-3 py-2" required placeholder="e.g., 2025">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Fund Source / Budget Name <span class="text-red-500">*</span></label>
                        <select name="fund_source" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Select Fund Source</option>
                            <option value="DOST_GIA">DOST-GIA (Grants-in-Aid)</option>
                            <option value="SETUP">SETUP (Small Enterprise Technology Upgrading Program)</option>
                            <option value="LOCAL_REGIONAL">Local/Regional Funds</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                </div>
                <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                    <p class="text-sm text-blue-700">
                        <span class="material-icons text-sm align-middle">lightbulb</span>
                        <strong>Note:</strong> Equipment value is automatically calculated when you allocate equipment items to this budget. You can optionally set an initial estimated value below.
                    </p>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium">Initial Equipment Value (Optional)</label>
                        <input type="number" step="0.01" name="total_amount" class="w-full border rounded-lg px-3 py-2" placeholder="‚Ç±0.00 - Leave blank to calculate from allocations">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">LIB Category</label>
                        <select name="lib_category" class="w-full border rounded-lg px-3 py-2">
                            <option value="EO_CO">Equipment/Capital Outlay</option>
                            <option value="MOOE">Maintenance & Other Operating Expenses</option>
                            <option value="PS">Personal Services</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium">Allocation Status</label>
                    <select name="status" class="w-full border rounded-lg px-3 py-2">
                        <option value="pending_procurement">Pending Procurement - Equipment being procured</option>
                        <option value="available">Available for Allocation - Ready to allocate to projects</option>
                        <option value="partially_allocated">Partially Allocated - Some equipment assigned</option>
                        <option value="fully_allocated">Fully Allocated - All equipment assigned</option>
                        <option value="completed">Completed - All equipment delivered</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium">Budget Documents <span class="text-gray-500 text-xs">(Multiple files allowed)</span></label>
                    <input type="file" name="budget_documents" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" multiple class="w-full border rounded-lg px-3 py-2">
                    <p class="text-xs text-gray-500 mt-1">Supported: PDF, Word, Excel, Images</p>
                </div>
                <div class="flex justify-end gap-2 pt-3">
                    <button type="button" @click="openAdd = false" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Budget</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Budget Modal -->
    <div id="editModal" style="display: none;" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto">
        <div class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg mt-10 mb-10 overflow-y-auto max-h-[90vh]">
            <h2 class="text-lg font-semibold mb-4">Edit Budget (Equipment Allocation)</h2>
            <p class="text-sm text-gray-600 mb-4">
                <span class="material-icons text-blue-500 align-middle text-sm">info</span>
                Budget values are primarily calculated from equipment allocations. You can adjust the estimated equipment value if needed.
            </p>
            <form id="editForm" method="POST" enctype="multipart/form-data" class="space-y-3">
                {% csrf_token %}
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium">Fiscal Year <span class="text-red-500">*</span></label>
                        <input type="number" id="edit_fiscal_year" name="fiscal_year" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Fund Source <span class="text-red-500">*</span></label>
                        <select id="edit_fund_source" name="fund_source" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="DOST_GIA">DOST-GIA (Grants-in-Aid)</option>
                            <option value="SETUP">SETUP (Small Enterprise Technology Upgrading Program)</option>
                            <option value="LOCAL_REGIONAL">Local/Regional Funds</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                </div>
                <div class="bg-gray-50 border border-gray-200 p-3 rounded-lg">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-600">Equipment Value (Allocated)</label>
                            <input type="number" step="0.01" id="edit_total_amount" name="total_amount" class="w-full border rounded-lg px-3 py-2 bg-gray-100" readonly>
                            <p class="text-xs text-gray-500 mt-1">Calculated from equipment allocations</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600">Equipment Value (Delivered)</label>
                            <input type="number" step="0.01" id="edit_delivered_amount" name="delivered_amount" class="w-full border rounded-lg px-3 py-2">
                            <p class="text-xs text-gray-500 mt-1">Value of equipment already delivered</p>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium">Allocation Status</label>
                    <select id="edit_status" name="status" class="w-full border rounded-lg px-3 py-2">
                        <option value="pending_procurement">Pending Procurement</option>
                        <option value="available">Available for Allocation</option>
                        <option value="partially_allocated">Partially Allocated</option>
                        <option value="fully_allocated">Fully Allocated</option>
                        <option value="completed">Completed</option>
                        <option value="archived">Archived</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Current stage in the equipment procurement/delivery process</p>
                </div>
                <div>
                    <label class="block text-sm font-medium">Add More Documents <span class="text-gray-500 text-xs">(Multiple files allowed)</span></label>
                    <input type="file" name="budget_documents" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" multiple class="w-full border rounded-lg px-3 py-2">
                    <p class="text-xs text-gray-500 mt-1">New files will be added to existing documents</p>
                </div>
                <div class="flex justify-end gap-2 pt-3">
                    <button type="button" onclick="document.getElementById('editModal').style.display='none';" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Update Budget</button>
                </div>
            </form>
        </div>
    </div>

</div>

<script>
$(document).ready(function () {
    $('#budgetsTable').DataTable();

    document.querySelectorAll('.editBtn').forEach(button => {
        button.addEventListener('click', function () {
            document.getElementById('edit_fiscal_year').value = this.dataset.fiscal_year;
            document.getElementById('edit_fund_source').value = this.dataset.fund_source;
            document.getElementById('edit_total_amount').value = this.dataset.total_amount;
            // Calculate delivered amount (total - remaining)
            const totalAmt = parseFloat(this.dataset.total_amount) || 0;
            const remainingAmt = parseFloat(this.dataset.remaining_amount) || 0;
            document.getElementById('edit_delivered_amount').value = (totalAmt - remainingAmt).toFixed(2);
            // Set the status - handle legacy status values
            let status = this.dataset.status;
            if (status === 'active') status = 'available';
            if (status === 'exhausted') status = 'fully_allocated';
            document.getElementById('edit_status').value = status;
            document.getElementById('editForm').action = `/administrator/budgets/update/${this.dataset.id}/`;
            document.getElementById('editModal').style.display = 'flex';
        });
    });

    // -----------------------------
    // Budget Status Pie Chart
    // -----------------------------
    const statusCounts = JSON.parse(document.getElementById('statusCounts').textContent);
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['Available', 'Partially Allocated', 'Fully Allocated', 'Completed'],
            datasets: [{
                data: [
                    (statusCounts.available || 0) + (statusCounts.active || 0), 
                    statusCounts.partially_allocated || 0, 
                    (statusCounts.fully_allocated || 0) + (statusCounts.exhausted || 0),
                    statusCounts.completed || 0
                ],
                backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(147, 51, 234, 0.7)', 'rgba(20, 184, 166, 0.7)'],
                borderColor: ['rgba(34, 197, 94, 1)', 'rgba(59, 130, 246, 1)', 'rgba(147, 51, 234, 1)', 'rgba(20, 184, 166, 1)'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            cutout: '50%',
            plugins: {
                legend: { position: 'bottom', labels: { font: { size: 11 } } },
                title: { display: false }
            }
        }
    });

    // -----------------------------
    // Fund Source Stacked Bar Chart
    // -----------------------------
    const fundSourceLabels = JSON.parse(document.getElementById('fundSourceLabels').textContent);
    const fundSourceSpent = JSON.parse(document.getElementById('fundSourceSpent').textContent);
    const fundSourceRemaining = JSON.parse(document.getElementById('fundSourceRemaining').textContent);
    
    const ctxFundSource = document.getElementById('fundSourceChart').getContext('2d');
    new Chart(ctxFundSource, {
        type: 'bar',
        data: {
            labels: fundSourceLabels,
            datasets: [
                {
                    label: 'Allocated',
                    data: fundSourceSpent,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Remaining',
                    data: fundSourceRemaining,
                    backgroundColor: 'rgba(34, 197, 94, 0.7)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true, title: { display: false } },
                y: { 
                    stacked: true, 
                    beginAtZero: true,
                    title: { display: true, text: 'Amount (‚Ç±)', font: { size: 10 } },
                    ticks: { 
                        callback: function(value) { return '‚Ç±' + value.toLocaleString(); }
                    }
                }
            },
            plugins: {
                legend: { position: 'bottom', labels: { font: { size: 10 } } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ‚Ç±' + Number(context.raw).toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // -----------------------------
    // Fiscal Year Stacked Bar Chart
    // -----------------------------
    const fiscalYearLabels = JSON.parse(document.getElementById('fiscalYearLabels').textContent);
    const fiscalYearSpent = JSON.parse(document.getElementById('fiscalYearSpent').textContent);
    const fiscalYearRemaining = JSON.parse(document.getElementById('fiscalYearRemaining').textContent);
    
    const ctxFiscalYear = document.getElementById('fiscalYearChart').getContext('2d');
    new Chart(ctxFiscalYear, {
        type: 'bar',
        data: {
            labels: fiscalYearLabels,
            datasets: [
                {
                    label: 'Allocated',
                    data: fiscalYearSpent,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Remaining',
                    data: fiscalYearRemaining,
                    backgroundColor: 'rgba(139, 92, 246, 0.7)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true, title: { display: false } },
                y: { 
                    stacked: true, 
                    beginAtZero: true,
                    title: { display: true, text: 'Amount (‚Ç±)', font: { size: 10 } },
                    ticks: { 
                        callback: function(value) { return '‚Ç±' + value.toLocaleString(); }
                    }
                }
            },
            plugins: {
                legend: { position: 'bottom', labels: { font: { size: 10 } } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ‚Ç±' + Number(context.raw).toLocaleString();
                        }
                    }
                }
            }
        }
    });
});
    </script>
    <script type="application/json" id="statusCounts">{{ status_counts|safe }}</script>
    <script type="application/json" id="fundSourceLabels">{{ fund_source_labels|safe }}</script>
    <script type="application/json" id="fundSourceSpent">{{ fund_source_spent|safe }}</script>
    <script type="application/json" id="fundSourceRemaining">{{ fund_source_remaining|safe }}</script>
    <script type="application/json" id="fiscalYearLabels">{{ fiscal_year_labels|safe }}</script>
    <script type="application/json" id="fiscalYearSpent">{{ fiscal_year_spent|safe }}</script>
    <script type="application/json" id="fiscalYearRemaining">{{ fiscal_year_remaining|safe }}</script>
{% endblock %}
